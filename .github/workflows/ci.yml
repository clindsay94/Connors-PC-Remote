name: CI

on:
    push:
        branches: [main, New-Features]
        paths-ignore:
            - "**.md"
            - ".github/*.md"
            - "LICENSE"
    pull_request:
        branches: [main]
        paths-ignore:
            - "**.md"
            - ".github/*.md"
            - "LICENSE"
    workflow_dispatch:

permissions:
    contents: read

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    DOTNET_NOLOGO: true
    DOTNET_CLI_TELEMETRY_OPTOUT: true
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
    build:
        name: Build & Test
        runs-on: windows-latest
        timeout-minutes: 15

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: Setup .NET 10
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"

            - name: Cache NuGet packages
              uses: actions/cache@v4
              with:
                  path: ~/.nuget/packages
                  key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
                  restore-keys: |
                      ${{ runner.os }}-nuget-

            - name: Restore dependencies
              run: dotnet restore CPCRemote.sln

            - name: Build solution
              run: dotnet build CPCRemote.sln --configuration Release --no-restore

            - name: Run tests
              run: dotnet test CPCRemote.sln --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: test-results
                  path: "**/TestResults/*.trx"
                  retention-days: 7

    code-quality:
        name: Code Quality
        runs-on: windows-latest
        timeout-minutes: 10
        needs: build

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: Setup .NET 10
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"

            - name: Cache NuGet packages
              uses: actions/cache@v4
              with:
                  path: ~/.nuget/packages
                  key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
                  restore-keys: |
                      ${{ runner.os }}-nuget-

            - name: Restore dependencies
              run: dotnet restore CPCRemote.sln

            - name: Check formatting
              run: dotnet format CPCRemote.sln --verify-no-changes --verbosity diagnostic
              continue-on-error: true

            - name: Build with warnings as errors
              run: dotnet build CPCRemote.sln --configuration Release --no-restore /warnaserror
