<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="CPCRemote.UI.Pages.ServiceManagementPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="using:CPCRemote.UI.Pages"
    mc:Ignorable="d"
    x:DataType="local:ServiceManagementPage"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <ScrollViewer>
        <StackPanel Padding="24" Spacing="16" MaxWidth="800">
            <TextBlock Text="Service Management" Style="{StaticResource TitleTextBlockStyle}"/>
            
            <TextBlock TextWrapping="Wrap" 
                       Text="Manage the Connor's PC Remote Windows Service directly from the GUI. Install, configure, and control the service without using PowerShell scripts."/>

            <!-- Service Status Section -->
            <Expander Header="Service Status" IsExpanded="True" HorizontalAlignment="Stretch" Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}">
                <StackPanel Spacing="12" Padding="12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="Status:" FontWeight="SemiBold" MinWidth="120"/>
                        <TextBlock Text="{x:Bind ViewModel.ServiceStatusText, Mode=OneWay}" Foreground="{ThemeResource SystemAccentColor}"/>
                    </StackPanel>
                    
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="Installation:" FontWeight="SemiBold" MinWidth="120"/>
                        <TextBlock Text="{x:Bind ViewModel.ServiceInstalledText, Mode=OneWay}"/>
                    </StackPanel>
                    
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Command="{x:Bind ViewModel.RefreshStatusCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE72C;"/>
                                <TextBlock Text="Refresh Status" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <ProgressRing IsActive="{x:Bind ViewModel.IsBusy, Mode=OneWay}" Width="20" Height="20"/>
                    </StackPanel>
                </StackPanel>
            </Expander>

            <!-- Service Control Section -->
            <Expander Header="Service Control" IsExpanded="True" HorizontalAlignment="Stretch" Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}">
                <StackPanel Spacing="12" Padding="12">
                    <InfoBar IsOpen="{x:Bind ViewModel.IsInfoBarOpen, Mode=OneWay}"
                             Message="{x:Bind ViewModel.InfoBarMessage, Mode=OneWay}"
                             Severity="{x:Bind ViewModel.InfoBarSeverity, Mode=OneWay}"
                             IsClosable="True"/>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Command="{x:Bind ViewModel.StartServiceCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE768;"/>
                                <TextBlock Text="Start Service" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <Button Command="{x:Bind ViewModel.StopServiceCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE71A;"/>
                                <TextBlock Text="Stop Service" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <Button Command="{x:Bind ViewModel.RestartServiceCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE777;"/>
                                <TextBlock Text="Restart Service" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Expander>

            <!-- Quick Actions Section -->
            <Expander Header="Quick Actions" IsExpanded="True" HorizontalAlignment="Stretch" Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}">
                <StackPanel Spacing="12" Padding="12">
                    <TextBlock TextWrapping="Wrap" 
                               Text="Send common commands to the remote PC. The service must be running."/>
                    
                    <ToggleSwitch Header="Safety Lock" 
                                  IsOn="{x:Bind ViewModel.IsSafetyLockEnabled, Mode=TwoWay}"
                                  OnContent="Enabled" 
                                  OffContent="Disabled"/>

                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                        <Button Command="{x:Bind ViewModel.ShutdownCommand}" IsEnabled="{x:Bind ViewModel.IsShutdownEnabled, Mode=OneWay}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE7E8;"/>
                                <TextBlock Text="Shutdown" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <Button Command="{x:Bind ViewModel.RestartCommand}" IsEnabled="{x:Bind ViewModel.IsShutdownEnabled, Mode=OneWay}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE777;"/>
                                <TextBlock Text="Restart" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <Button Command="{x:Bind ViewModel.LockCommand}" IsEnabled="{x:Bind ViewModel.IsShutdownEnabled, Mode=OneWay}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE72E;"/>
                                <TextBlock Text="Lock" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Expander>

            <!-- Installation Section -->
            <Expander Header="Installation" IsExpanded="False" HorizontalAlignment="Stretch" Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}">
                <StackPanel Spacing="12" Padding="12">
                    <TextBlock TextWrapping="Wrap" 
                               Text="Install or uninstall the Connor's PC Remote Windows Service. The service must be installed and running to accept remote commands."/>
                    
                    <TextBox x:Name="ExePathTextBox" 
                             Header="Service Executable Path" 
                             PlaceholderText="C:\Path\to\CPCRemote.Service.exe"
                             Text="{x:Bind ViewModel.ServiceExecutablePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                    
                    <Button Click="BrowseButton_Click">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE8E5;"/>
                            <TextBlock Text="Browse..." VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Command="{x:Bind ViewModel.InstallServiceCommand}"
                                CommandParameter="{x:Bind ViewModel.ServiceExecutablePath, Mode=OneWay}"
                                Style="{StaticResource AccentButtonStyle}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE896;"/>
                                <TextBlock Text="Install Service" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <Button Command="{x:Bind ViewModel.UninstallServiceCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE74D;"/>
                                <TextBlock Text="Uninstall Service" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <Button Command="{x:Bind ViewModel.CancelOperationCommand}" IsEnabled="{x:Bind ViewModel.IsBusy, Mode=OneWay}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE71A;"/>
                                <TextBlock Text="Cancel" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <ProgressRing IsActive="{x:Bind ViewModel.IsBusy, Mode=OneWay}" Value="{x:Bind ViewModel.Progress, Mode=OneWay}" IsIndeterminate="False" Width="200" Height="20"/>
                </StackPanel>
            </Expander>

            <!-- Configuration Section -->
            <Expander Header="Service Configuration" IsExpanded="False" HorizontalAlignment="Stretch" Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}">
                <StackPanel Spacing="12" Padding="12">
                    <TextBlock TextWrapping="Wrap" 
                               Text="Configure the HTTP listener settings. Changes require service restart to take effect."/>
                    
                    <TextBox Header="IP Address" 
                             PlaceholderText="localhost or 10.0.0.69"
                             Text="{x:Bind ViewModel.IpAddress, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                    
                    <NumberBox Header="Port" 
                               PlaceholderText="5005"
                               Minimum="1" 
                               Maximum="65535"
                               Value="{x:Bind ViewModel.Port, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                               SpinButtonPlacementMode="Inline"/>
                    
                    <PasswordBox Header="Secret (Optional)" 
                                 PlaceholderText="Leave empty for no secret"
                                 Password="{x:Bind ViewModel.Secret, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 PasswordRevealMode="Peek"/>

                    <TextBlock Text="Preview URL:" FontWeight="SemiBold"/>
                    <TextBlock Text="{x:Bind ViewModel.PreviewUrl, Mode=OneWay}" 
                               FontFamily="Consolas"
                               IsTextSelectionEnabled="True"
                               Foreground="{ThemeResource SystemAccentColor}"/>

                    <Button Command="{x:Bind ViewModel.SaveConfigurationCommand}"
                            Style="{StaticResource AccentButtonStyle}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE74E;"/>
                            <TextBlock Text="Save Configuration" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Expander>

            <!-- Test Commands Section -->
            <Expander Header="Test Commands" IsExpanded="False" HorizontalAlignment="Stretch" Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}">
                <StackPanel Spacing="12" Padding="12">
                    <TextBlock TextWrapping="Wrap" 
                               Text="Test the service by sending commands. Make sure the service is running before testing."/>
                    
                    <Button Command="{x:Bind ViewModel.TestPingCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE968;"/>
                            <TextBlock Text="Test Ping" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <TextBlock Text="Send Command:" FontWeight="SemiBold"/>
                    <ComboBox PlaceholderText="Select a command"
                              MinWidth="200">
                        <ComboBoxItem Content="Shutdown"/>
                        <ComboBoxItem Content="Restart"/>
                        <ComboBoxItem Content="Lock"/>
                        <ComboBoxItem Content="TurnScreenOff"/>
                        <ComboBoxItem Content="ForceShutdown"/>
                        <ComboBoxItem Content="UEFIReboot"/>
                    </ComboBox>

                    <Button IsEnabled="False">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE7C1;"/>
                            <TextBlock Text="Send Command (Warning: Will Execute!)" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Expander>

            <!-- URL Reservation Section -->
            <Expander Header="URL Reservation (Advanced)" IsExpanded="False" HorizontalAlignment="Stretch" Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}">
                <StackPanel Spacing="12" Padding="12">
                    <TextBlock TextWrapping="Wrap" 
                               Text="If the service fails to start with 'Access Denied' error, you may need to reserve the URL. This requires administrator privileges."/>
                    
                    <TextBlock TextWrapping="Wrap" FontStyle="Italic">
                        <Run Text="Command: "/>
                        <Run Text="netsh http add urlacl url=http://[address]:[port]/ user=EVERYONE" FontFamily="Consolas"/>
                    </TextBlock>

                    <Button>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE7EF;"/>
                            <TextBlock Text="Reserve URL (Requires Admin)" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Expander>
        </StackPanel>
    </ScrollViewer>
</Page>